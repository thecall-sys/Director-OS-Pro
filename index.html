<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director OS Pro V2.5 | 真实 AI 联动版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body, html, #root { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; color: #eee; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* 移动端适配：侧边栏在手机上自动收起 */
        .sidebar { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border-right: 1px solid #222; z-index: 50; transition: all 0.3s ease; }
        @media (max-width: 768px) { .sidebar { width: 100%; position: absolute; transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } }
        
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; }
        .react-flow__edge-path { stroke: #3b82f6; stroke-width: 3; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); }
        
        /* 电影感 GIF 容器 */
        .video-preview { position: relative; background: #000; overflow: hidden; border-radius: 12px; aspect-ratio: 16/9; }
        .video-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: opacity 0.5s; }
        .video-preview:hover img { opacity: 0.9; }

        input, textarea, select { background: #111 !important; border: 1px solid #333 !important; color: white !important; outline: none; border-radius: 12px !important; }
        input:focus { border-color: #3b82f6 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/react-flow-renderer.standalone.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        window.onload = function() {
            const { useState, useCallback, useEffect } = React;
            const RF = window.ReactFlowRenderer || window.ReactFlow;
            const ReactFlow = RF.default || RF;
            const { Background, Controls, Handle, Position } = RF;

            // --- 任务 2: 完善 Seedance 2.0 预览图 (GIF 模拟) ---
            const ShotNode = ({ data }) => (
                React.createElement("div", { className: "bg-[#0d0d0d] border border-white/10 rounded-2xl overflow-hidden w-[320px] shadow-2xl" }, [
                    React.createElement(Handle, { type: "target", position: Position.Left }),
                    React.createElement("div", { className: "video-preview" }, [
                        React.createElement("div", { className: "absolute top-2 left-2 bg-blue-600 px-2 py-0.5 rounded text-[9px] font-black z-10" }, `#SHOT-${data.id}`),
                        // 使用高质量电影感占位图
                        React.createElement("img", { src: data.previewUrl || "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJieXpueHoxeXh4ZHgxeHh4ZHgxeHh4ZHgxeHh4ZHgxeHh4ZHgmbXA9Zw/3o7TKMGpxx66VlZcQw/giphy.gif" }),
                        React.createElement("div", { className: "absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 hover:opacity-100 transition-opacity" }, 
                            React.createElement("button", { className: "bg-white text-black px-4 py-1.5 rounded-full text-[10px] font-black" }, "RE-GENERATE")
                        )
                    ]),
                    React.createElement("div", { className: "p-4 space-y-2" }, [
                        React.createElement("div", { className: "flex justify-between" }, [
                            React.createElement("span", { className: "text-[10px] text-blue-400 font-bold" }, data.shotSize),
                            React.createElement("span", { className: "text-[10px] text-green-500 font-mono" }, data.duration + "s")
                        ]),
                        React.createElement("p", { className: "text-[11px] text-gray-400 line-clamp-2 leading-relaxed" }, data.description),
                        React.createElement("div", { className: "pt-2 border-t border-white/5 flex justify-between text-[9px] text-gray-600 font-bold uppercase" }, [
                            React.createElement("span", null, data.motion),
                            React.createElement("i", { "data-lucide": "volume-2", className: "w-3 h-3" })
                        ])
                    ]),
                    React.createElement(Handle, { type: "source", position: Position.Right })
                ])
            );

            const nodeTypes = { shotNode: ShotNode };

            function DirectorOS() {
                const [nodes, setNodes] = useState([]);
                const [edges, setEdges] = useState([]);
                const [script, setScript] = useState("");
                const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || "");
                const [loading, setLoading] = useState(false);
                const [sidebarOpen, setSidebarOpen] = useState(true);

                // --- 任务 1: 注入真实 Gemini API 逻辑 ---
                const handleExpand = async () => {
                    if(!apiKey) return alert("请先输入 Gemini API Key");
                    if(!script) return alert("请输入剧本创意");
                    
                    setLoading(true);
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `你是一位专业导演。基于剧本创意: "${script}"，请拆解出9个分镜。输出必须是JSON数组格式，包含字段: id(1-9), shotSize(景别), description(画面描述), motion(镜头运动), duration(秒数)。请只输出JSON，不要带Markdown。` }]}]
                            })
                        });
                        const resData = await response.json();
                        const rawText = resData.candidates[0].content.parts[0].text;
                        const shots = JSON.parse(rawText.replace(/```json|```/g, ''));

                        const newNodes = shots.map((s, i) => ({
                            id: `shot-${i}`, type: 'shotNode',
                            position: { x: 500 + (i % 3) * 380, y: Math.floor(i / 3) * 320 },
                            data: { ...s, previewUrl: `https://picsum.photos/seed/${i+Math.random()}/400/225` }
                        }));

                        const newEdges = Array.from({ length: 8 }).map((_, i) => ({
                            id: `e${i}-${i+1}`, source: `shot-${i}`, target: `shot-${i+1}`, animated: true
                        }));

                        setNodes(newNodes);
                        setEdges(newEdges);
                    } catch (e) {
                        alert("API 调用失败，请检查 Key 或网络环境。");
                    }
                    setLoading(false);
                };

                return React.createElement("div", { className: "flex h-full w-full relative" }, [
                    // 移动端菜单开关
                    React.createElement("button", { 
                        className: "md:hidden fixed top-4 left-4 z-[60] bg-blue-600 p-2 rounded-lg",
                        onClick: () => setSidebarOpen(!sidebarOpen)
                    }, React.createElement("i", { "data-lucide": sidebarOpen ? "x" : "menu" })),

                    // --- 任务 3: 优化移动端适配 (侧边栏) ---
                    React.createElement("aside", { className: `sidebar ${sidebarOpen ? 'open' : ''} w-full md:w-[400px] p-8 flex flex-col gap-6` }, [
                        React.createElement("div", { className: "flex items-center gap-3 mb-4" }, [
                            React.createElement("div", { className: "w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg" }, 
                                React.createElement("i", { "data-lucide": "clapperboard", className: "text-white w-6 h-6" })),
                            React.createElement("h1", { className: "text-2xl font-black italic tracking-tighter" }, "DIRECTOR OS")
                        ]),
                        
                        React.createElement("div", { className: "glass-card p-5 space-y-4" }, [
                            React.createElement("label", { className: "text-[10px] font-bold text-gray-500 uppercase" }, "Gemini API 授权"),
                            React.createElement("input", { 
                                type: "password", placeholder: "在此粘贴您的 API Key", 
                                className: "w-full p-3 text-xs", value: apiKey,
                                onChange: (e) => { setApiKey(e.target.value); localStorage.setItem('gemini_key', e.target.value); }
                            })
                        ]),

                        React.createElement("textarea", { 
                            className: "w-full h-40 p-4 text-xs", placeholder: "输入创意剧本...",
                            onChange: (e) => setScript(e.target.value)
                        }),

                        React.createElement("button", { 
                            className: `w-full py-4 rounded-2xl text-xs font-black transition-all ${loading ? 'bg-gray-700' : 'bg-blue-600 hover:bg-blue-500 shadow-blue-500/20 shadow-xl'}`,
                            onClick: handleExpand, disabled: loading
                        }, loading ? "正在请求 Gemini 3.1..." : "执行智能分镜拆解")
                    ]),

                    // 画布区
                    React.createElement("div", { className: "flex-1 relative bg-[#050505]" }, [
                        React.createElement(ReactFlow, { nodes, edges, nodeTypes, fitView: true }, [
                            React.createElement(Background, { color: "#222", gap: 20 }),
                            React.createElement(Controls)
                        ])
                    ])
                ]);
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(DirectorOS));
            setTimeout(() => lucide.createIcons(), 500);
        };
    </script>
</body>
</html>

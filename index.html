<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director OS Pro V2.5 | 生产力完全体</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body, html, #root { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; color: #eee; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* 任务 3: 移动端适配 CSS */
        .sidebar { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border-right: 1px solid #222; z-index: 50; transition: transform 0.3s ease; }
        @media (max-width: 1024px) { 
            .sidebar { position: absolute; width: 320px; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .mobile-toggle { display: block !important; }
        }

        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; }
        .react-flow__edge-path { stroke: #3b82f6; stroke-width: 3; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); }
        
        /* 任务 2: 动态预览增强 */
        .shot-card { background: #0d0d0d; border: 1px solid #222; border-radius: 20px; overflow: hidden; }
        .video-container { background: #000; position: relative; aspect-ratio: 16/9; overflow: hidden; }
        .video-container img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: opacity 0.3s; }
        .video-container:hover img { opacity: 1; }

        input, textarea, select { background: #111 !important; border: 1px solid #333 !important; border-radius: 12px !important; color: white !important; outline: none; }
        #loading-overlay { position: fixed; inset: 0; background: #050505; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div style="width:40px; height:40px; border:3px solid #3b82f6; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; font-size:12px; letter-spacing:2px; color:#666;">DIRECTOR OS V2.5 引擎自检中...</p>
    </div>

    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/react-flow-renderer.standalone.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- 容错式加载检测 ---
        function initApp() {
            const RF = window.ReactFlowRenderer || window.ReactFlow;
            if (!RF || !window.React) {
                console.log("正在重试加载核心库...");
                setTimeout(initApp, 500);
                return;
            }
            document.getElementById('loading-overlay').style.display = 'none';
            startDirectorOS(RF);
        }

        function startDirectorOS(RFProvider) {
            const { useState, useEffect, useCallback } = React;
            const ReactFlow = RFProvider.default || RFProvider;
            const { Background, Controls, Handle, Position } = RFProvider;

            // 任务 2: 分镜卡片 UI
            const ShotNode = ({ data }) => React.createElement("div", { className: "shot-card w-[320px] shadow-2xl" }, [
                React.createElement(Handle, { type: "target", position: Position.Left }),
                React.createElement("div", { className: "video-container" }, [
                    React.createElement("div", { className: "absolute top-2 left-2 bg-blue-600 px-2 py-0.5 rounded text-[9px] font-black z-10" }, `#${data.id}`),
                    React.createElement("img", { src: data.previewUrl || `https://picsum.photos/seed/${data.id}/400/225` }),
                    React.createElement("div", { className: "absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 hover:opacity-100 transition-opacity" }, 
                        React.createElement("button", { className: "bg-white text-black px-4 py-1.5 rounded-full text-[10px] font-black" }, "SEEDANCE V2 PREVIEW")
                    )
                ]),
                React.createElement("div", { className: "p-4 space-y-2" }, [
                    React.createElement("div", { className: "flex justify-between" }, [
                        React.createElement("span", { className: "text-[10px] text-blue-400 font-bold uppercase" }, data.shotSize || "中景"),
                        React.createElement("span", { className: "text-[10px] text-green-500 font-mono" }, (data.duration || "2.5") + "s")
                    ]),
                    React.createElement("p", { className: "text-[11px] text-gray-400 line-clamp-2" }, data.description),
                ]),
                React.createElement(Handle, { type: "source", position: Position.Right })
            ]);

            const nodeTypes = { shotNode: ShotNode };

            function App() {
                const [nodes, setNodes] = useState([]);
                const [edges, setEdges] = useState([]);
                const [script, setScript] = useState("");
                const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || "");
                const [isSidebarOpen, setSidebarOpen] = useState(true);
                const [loading, setLoading] = useState(false);

                // 任务 1: Gemini 3.1 真实调用
                const handleGenerate = async () => {
                    if (!apiKey) return alert("请在侧边栏输入 API Key");
                    setLoading(true);
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `作为导演，将剧本"${script}"拆解为9个技术分镜JSON。包含字段：id, shotSize, description, duration。只返回JSON，不要Markdown。` }]}]
                            })
                        });
                        const json = await res.json();
                        const raw = json.candidates[0].content.parts[0].text;
                        const shots = JSON.parse(raw.replace(/```json|```/g, ''));
                        
                        const newNodes = shots.map((s, i) => ({
                            id: `s-${i}`, type: 'shotNode',
                            position: { x: 500 + (i % 3) * 380, y: Math.floor(i / 3) * 320 },
                            data: { ...s, id: i+1 }
                        }));
                        setNodes(newNodes);
                        setEdges(Array.from({length:8}).map((_,i)=>({id:`e-${i}`, source:`s-${i}`, target:`s-${i+1}`, animated:true})));
                    } catch (e) { alert("API 调用失败，请检查 Key 或网络。"); }
                    setLoading(false);
                };

                return React.createElement("div", { className: "flex h-full relative" }, [
                    // 移动端切换按钮
                    React.createElement("button", { 
                        className: "mobile-toggle hidden fixed bottom-6 right-6 z-[100] bg-blue-600 p-4 rounded-full shadow-xl",
                        onClick: () => setSidebarOpen(!isSidebarOpen)
                    }, React.createElement("i", { "data-lucide": isSidebarOpen ? "x" : "settings" })),

                    // 侧边栏
                    React.createElement("aside", { className: `sidebar ${isSidebarOpen ? 'open' : ''} w-[380px] p-8 flex flex-col gap-6` }, [
                        React.createElement("h1", { className: "text-2xl font-black italic tracking-tighter text-blue-500" }, "DIRECTOR OS V2.5"),
                        React.createElement("div", { className: "glass-card p-5 space-y-4" }, [
                            React.createElement("p", { className: "text-[10px] font-bold text-gray-500 uppercase" }, "API 授权 (Task 1)"),
                            React.createElement("input", { 
                                type: "password", placeholder: "Gemini API Key", className: "w-full p-3 text-xs", 
                                value: apiKey, onChange: (e) => { setApiKey(e.target.value); localStorage.setItem('gemini_key', e.target.value); }
                            })
                        ]),
                        React.createElement("textarea", { className: "w-full h-40 p-4 text-xs", placeholder: "输入剧本创意...", onChange: (e) => setScript(e.target.value) }),
                        React.createElement("button", { 
                            className: "w-full py-4 bg-blue-600 rounded-2xl font-black text-xs hover:bg-blue-500 transition-all",
                            onClick: handleGenerate
                        }, loading ? "AI 正在拆解..." : "执行智能拆解")
                    ]),

                    // 画布 (Task 3: iPad 捏合缩放适配)
                    React.createElement("div", { className: "flex-1 bg-[#050505]" }, [
                        React.createElement(ReactFlow, { nodes, edges, nodeTypes, fitView: true }, [
                            React.createElement(Background, { color: "#222", gap: 20 }),
                            React.createElement(Controls)
                        ])
                    ])
                ]);
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
            setTimeout(() => lucide.createIcons(), 500);
        }

        // 启动检测
        initApp();
    </script>
</body>
</html>
